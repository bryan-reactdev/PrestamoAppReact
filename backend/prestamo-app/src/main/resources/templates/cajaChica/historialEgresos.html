<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{appDashboard/admin/layout :: layout(
          pageTitle='',
          pageSubtitle='',
          activePage='cajaChica',
          content=~{::content},
          pageCss=~{::css},
          pageScripts=~{::scripts}
      )}">
<head>
    <th:block th:fragment="css">
        <link rel="stylesheet" type="text/css" th:href="@{/css/RegistroEgreso.css}" />
        <style>
            .clickable-card {
                cursor: pointer;
                transition: all 0.3s ease;
                border: 2px solid transparent;
            }
            
            .clickable-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            }
            
            .clickable-card.active {
                border-color: #007bff;
                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            }
            
            .section-container {
                display: none;
            }
            
            .section-container.active {
                display: block;
            }
        </style>
    </th:block>
</head>
<body>
<div th:fragment="content">

    <!-- Cabecera con controles -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="total-card total-general">
                <div class="total-controls">
                    <div class="date-controls">
                        <div class="date-selector">
                            <label for="fechaSelector">Fecha:</label>
                            <input type="date" id="fechaSelector" class="form-control">
                        </div>
                        <button class="btn btn-primary btn-hoy">
                            <i class="fas fa-rotate"></i> Hoy
                        </button>
                    </div>
                    <button class="btn btn-danger btn-generar-pdf">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </button>
                </div>
                <div class="total-main-content">
                    <div class="total-icon"><i class="fas fa-chart-line"></i></div>
                    <div class="total-content">
                        <div class="total-label">Egreso Total</div>
                        <div class="total-amount" id="total-egreso">$0.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Totales - Now Clickable Cards -->
    <div class="totales-section">
        <div class="totales-grid">
            <div class="total-card total-desembolsos clickable-card active" data-section="desembolsos">
                <div class="total-icon"><i class="fas fa-hand-holding-usd"></i></div>
                <div class="total-content">
                    <div class="total-label">Total Créditos Desembolsados</div>
                    <div class="total-amount" id="total-desembolsos">$0.00</div>
                </div>
            </div>
            <div class="total-card total-gastos-empresa clickable-card" data-section="gastos-empresa">
                <div class="total-icon"><i class="fas fa-receipt"></i></div>
                <div class="total-content">
                    <div class="total-label">Total Gastos Empresa</div>
                    <div class="total-amount" id="total-gastos-empresa">$0.00</div>
                </div>
            </div>
            <div class="total-card total-gastos-varios clickable-card" data-section="gastos-varios">
                <div class="total-icon"><i class="fas fa-coins"></i></div>
                <div class="total-content">
                    <div class="total-label">Total Gastos Varios</div>
                    <div class="total-amount" id="total-gastos-varios">$0.00</div>
                </div>
            </div>
            <div class="total-card total-retiros-cuotas clickable-card" data-section="retiros-cuotas">
                <div class="total-icon"><i class="fas fa-money-bill-wave"></i></div>
                <div class="total-content">
                    <div class="total-label">Total Retiros de Cuotas</div>
                    <div class="total-amount" id="total-retiros-cuotas">$0.00</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section Contents -->
    <div class="section-container active" id="section-desembolsos">
        <div class="section-header">
            <h2><i class="fas fa-hand-holding-usd"></i> Créditos Desembolsados</h2>
            <div class="section-actions">
                <div class="search-box">
                    <input type="text" id="searchDesembolsos" placeholder="Buscar en desembolsos..." class="form-control">
                    <i class="fas fa-search"></i>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="tablaDesembolsos">
                <thead>
                <tr>
                    <th>Usuario</th><th>DUI</th><th>Monto</th>
                    <th>Monto a Dar</th><th>Fecha Desembolso</th><th>Frecuencia de Pago</th>
                </tr>
                </thead>
                <tbody id="tbodyDesembolsos"></tbody>
            </table>
        </div>
        <div class="table-footer">
            <div class="table-info">
                Mostrando <span id="desembolsosCount">0</span> registros de <span id="totalDesembolsosCount">0</span>
            </div>
            <div class="pagination-controls" id="paginacionDesembolsos">
                <button class="btn btn-sm btn-outline-secondary btn-prev-desembolsos" disabled>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-info">Página <span id="paginaActualDesembolsos">1</span> de <span id="totalPaginasDesembolsos">1</span></span>
                <button class="btn btn-sm btn-outline-secondary btn-next-desembolsos" disabled>
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="section-container" id="section-gastos-empresa">
        <div class="section-header">
            <h2><i class="fas fa-building"></i> Gastos de la Empresa</h2>
            <div class="section-actions">
                <div class="search-box">
                    <input type="text" id="searchGastosEmpresa" placeholder="Buscar en gastos empresa..." class="form-control">
                    <i class="fas fa-search"></i>
                </div>
                <button class="btn btn-success btn-nuevo-gastos-empresa">
                    <i class="fas fa-plus"></i> Nuevo Gasto Empresa
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="tablaGastosEmpresa">
                <thead>
                <tr>
                    <th>Monto</th><th>Motivo</th><th>Fecha</th>
                </tr>
                </thead>
                <tbody id="tbodyGastosEmpresa"></tbody>
            </table>
        </div>
        <div class="table-footer">
            <div class="table-info">
                Mostrando <span id="gastos-empresaCount">0</span> registros de <span id="totalGastosEmpresaCount">0</span>
            </div>
            <div class="pagination-controls" id="paginacionGastosEmpresa">
                <button class="btn btn-sm btn-outline-secondary btn-prev-gastos-empresa" disabled>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-info">Página <span id="paginaActualGastosEmpresa">1</span> de <span id="totalPaginasGastosEmpresa">1</span></span>
                <button class="btn btn-sm btn-outline-secondary btn-next-gastos-empresa" disabled>
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="section-container" id="section-gastos-varios">
        <div class="section-header">
            <h2><i class="fas fa-coins"></i> Gastos Varios</h2>
            <div class="section-actions">
                <div class="search-box">
                    <input type="text" id="searchGastosVarios" placeholder="Buscar en gastos varios..." class="form-control">
                    <i class="fas fa-search"></i>
                </div>
                <button class="btn btn-success btn-nuevo-gastos-varios">
                    <i class="fas fa-plus"></i> Nuevo Gasto Varios
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="tablaGastosVarios">
                <thead>
                <tr>
                    <th>Monto</th><th>Motivo</th><th>Fecha</th>
                </tr>
                </thead>
                <tbody id="tbodyGastosVarios"></tbody>
            </table>
        </div>
        <div class="table-footer">
            <div class="table-info">
                Mostrando <span id="gastos-variosCount">0</span> registros de <span id="totalGastosVariosCount">0</span>
            </div>
            <div class="pagination-controls" id="paginacionGastosVarios">
                <button class="btn btn-sm btn-outline-secondary btn-prev-gastos-varios" disabled>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-info">Página <span id="paginaActualGastosVarios">1</span> de <span id="totalPaginasGastosVarios">1</span></span>
                <button class="btn btn-sm btn-outline-secondary btn-next-gastos-varios" disabled>
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="section-container" id="section-retiros-cuotas">
        <div class="section-header">
            <h2><i class="fas fa-money-bill-wave"></i> Retiros de Cuotas</h2>
            <div class="section-actions">
                <div class="search-box">
                    <input type="text" id="searchRetirosCuotas" placeholder="Buscar en retiros de cuotas..." class="form-control">
                    <i class="fas fa-search"></i>
                </div>
                <button class="btn btn-success btn-nuevo-retiros-cuotas">
                    <i class="fas fa-plus"></i> Nuevo Retiro de Cuotas
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="data-table" id="tablaRetirosCuotas">
                <thead>
                <tr>
                    <th>Monto</th><th>Motivo</th><th>Fecha</th>
                </tr>
                </thead>
                <tbody id="tbodyRetirosCuotas"></tbody>
            </table>
        </div>
        <div class="table-footer">
            <div class="table-info">
                Mostrando <span id="retiros-cuotasCount">0</span> registros de <span id="totalRetirosCuotasCount">0</span>
            </div>
            <div class="pagination-controls" id="paginacionRetirosCuotas">
                <button class="btn btn-sm btn-outline-secondary btn-prev-retiros-cuotas" disabled>
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-info">Página <span id="paginaActualRetirosCuotas">1</span> de <span id="totalPaginasRetirosCuotas">1</span></span>
                <button class="btn btn-sm btn-outline-secondary btn-next-retiros-cuotas" disabled>
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<th:block th:fragment="scripts">
    <script th:inline="javascript">
        // Configuración centralizada
        const CONFIG = {
            registrosPorPagina: 10,
            fechaActual: new Date(),
            tipos: ['desembolsos', 'gastos-empresa', 'gastos-varios', 'retiros-cuotas']
        };

        // Estado de la aplicación
        const estado = {
            fechaSeleccionada: null,
            datos: {
                desembolsos: /*[[${creditosDesembolsados}]]*/ [],
                gastos: /*[[${cajaGastos}]]*/ []
            },
            filtrados: { desembolsos: [], 'gastos-empresa': [], 'gastos-varios': [], 'retiros-cuotas': [] },
            paginas: { desembolsos: 1, 'gastos-empresa': 1, 'gastos-varios': 1, 'retiros-cuotas': 1 },
            seccionActiva: 'desembolsos'
        };

        // Helper function for capitalization
        const capitalize = (str) => str.split('-').map(word => 
            word.charAt(0).toUpperCase() + word.slice(1)
        ).join('');

        // Section Manager
        const SectionManager = {
            inicializar() {
                this.inicializarEventos();
            },

            inicializarEventos() {
                // Card click events
                document.querySelectorAll('.clickable-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const sectionId = e.currentTarget.getAttribute('data-section');
                        this.cambiarSeccion(sectionId);
                    });
                });
            },

            cambiarSeccion(sectionId) {
                // Update active card
                document.querySelectorAll('.clickable-card').forEach(card => {
                    card.classList.remove('active');
                });
                document.querySelector(`.clickable-card[data-section="${sectionId}"]`).classList.add('active');

                // Update active section
                document.querySelectorAll('.section-container').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById(`section-${sectionId}`).classList.add('active');

                // Update state
                estado.seccionActiva = sectionId;
            }
        };

        // Utilidades
        const Utilidades = {
            formatearFechaParaInput: (fecha) => {
                if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) return fecha;
                const d = new Date(fecha);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            },

            formatearFecha: (fechaString) => {
                if (!fechaString) return 'N/A';
                try { return new Date(fechaString).toLocaleDateString('es-ES'); } 
                catch (e) { return 'N/A'; }
            },

            formatearMonto: (monto) => parseFloat(monto).toFixed(2)
        };

        const Utils = {
            formatDateForInput: (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },
        };

        // Lógica principal
        const RegistroEgresos = {
            inicializar() {
                this.inicializarUI();
                this.aplicarFiltroFecha();
                this.cargarTodasTablas();
                this.actualizarTotales();
                this.inicializarEventos();
                SectionManager.inicializar();
            },

            inicializarUI() {
                // Configurar fecha
                const fechaSelector = document.getElementById('fechaSelector');
                estado.fechaSeleccionada = Utilidades.formatearFechaParaInput(CONFIG.fechaActual);
                fechaSelector.value = estado.fechaSeleccionada;
            },

            aplicarFiltroFecha() {
                const fechaInput = document.getElementById('fechaSelector').value;
                if (!fechaInput) return;
                
                estado.fechaSeleccionada = fechaInput;
                
                CONFIG.tipos.forEach(tipo => {
                    let datos;
                    if (tipo === 'desembolsos') {
                        datos = estado.datos.desembolsos;
                    } else {
                        const tipoGasto = tipo === 'gastos-empresa' ? 'Empresa' : 
                                         tipo === 'gastos-varios' ? 'Varios' : 'Retiro de Cuotas';
                        datos = estado.datos.gastos.filter(gasto => gasto.tipo === tipoGasto);
                    }
                    
                    estado.filtrados[tipo] = datos.filter(item => {
                        const fechaItem = tipo === 'desembolsos' ? item.fechaDesembolsado : item.fecha;
                        if (!fechaItem) return false;
                        return Utilidades.formatearFechaParaInput(new Date(fechaItem)) === estado.fechaSeleccionada;
                    });
                    
                    estado.paginas[tipo] = 1;
                });
            },

            cargarTodasTablas() {
                CONFIG.tipos.forEach(tipo => this.cargarTabla(tipo));
            },

            cargarTabla(tipo) {
                const tipoCapitalizado = capitalize(tipo);
                const tbody = document.getElementById(`tbody${tipoCapitalizado}`);
                const datos = estado.filtrados[tipo];

                if (datos.length === 0) {
                    const columnas = tipo === 'desembolsos' ? 6 : 4;
                    const mensajes = {
                        'desembolsos': 'créditos desembolsados',
                        'gastos-empresa': 'gastos de empresa',
                        'gastos-varios': 'gastos varios',
                        'retiros-cuotas': 'retiros de cuotas'
                    };
                    
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="${columnas}" class="text-center text-muted">
                                <i class="fas fa-inbox"></i> No hay ${mensajes[tipo]} para esta fecha
                            </td>
                        </tr>
                    `;
                    this.actualizarContadores(tipo, 0, 0);
                    this.actualizarPaginacion(tipo);
                    return;
                }

                const inicio = (estado.paginas[tipo] - 1) * CONFIG.registrosPorPagina;
                const datosPaginados = datos.slice(inicio, inicio + CONFIG.registrosPorPagina);

                let html = '';
                datosPaginados.forEach(item => {
                    if (tipo === 'desembolsos') {
                        html += `
                            <tr>
                                <td>${item.usuario?.nombre || 'N/A'} ${item.usuario?.apellido || ''}</td>
                                <td>${item.usuario?.dui || 'N/A'}</td>
                                <td>$${Utilidades.formatearMonto(item.monto || 0)}</td>
                                <td>$${Utilidades.formatearMonto(item.montoDado || item.monto || 0)}</td>
                                <td>${Utilidades.formatearFecha(item.fechaDesembolsado)}</td>
                                <td>${item.plazoFrecuencia || 'N/A'}</td>
                            </tr>
                        `;
                    } else {
                        html += `
                            <tr>
                                <td>$${Utilidades.formatearMonto(item.monto || 0)}</td>
                                <td>${item.motivo || 'N/A'}</td>
                                <td>${Utilidades.formatearFecha(item.fecha)}</td>
                            </tr>
                        `;
                    }
                });

                tbody.innerHTML = html;
                this.actualizarContadores(tipo, datosPaginados.length, datos.length);
                this.actualizarPaginacion(tipo);
            },

            actualizarContadores(tipo, mostrados, total) {
                document.getElementById(`${tipo}Count`).textContent = mostrados;
                document.getElementById(`total${capitalize(tipo)}Count`).textContent = total;
            },

            actualizarPaginacion(tipo) {
                const totalPaginas = Math.ceil(estado.filtrados[tipo].length / CONFIG.registrosPorPagina);
                const tipoCapitalizado = capitalize(tipo);
                const elementos = {
                    prev: document.querySelector(`.btn-prev-${tipo}`),
                    next: document.querySelector(`.btn-next-${tipo}`),
                    actual: document.getElementById(`paginaActual${tipoCapitalizado}`),
                    total: document.getElementById(`totalPaginas${tipoCapitalizado}`)
                };

                elementos.actual.textContent = estado.paginas[tipo];
                elementos.total.textContent = totalPaginas;
                elementos.prev.disabled = estado.paginas[tipo] <= 1;
                elementos.next.disabled = estado.paginas[tipo] >= totalPaginas;
            },

            actualizarTotales() {
                const totales = CONFIG.tipos.reduce((acc, tipo) => {
                    acc[tipo] = estado.filtrados[tipo].reduce((sum, item) => {
                        if (tipo === 'desembolsos') {
                            return sum + parseFloat(item.montoDado || item.monto || 0);
                        } else {
                            return sum + parseFloat(item.monto || 0);
                        }
                    }, 0);
                    return acc;
                }, {});

                document.getElementById('total-gastos-empresa').textContent = `$${Utilidades.formatearMonto(totales['gastos-empresa'])}`;
                document.getElementById('total-gastos-varios').textContent = `$${Utilidades.formatearMonto(totales['gastos-varios'])}`;
                document.getElementById('total-retiros-cuotas').textContent = `$${Utilidades.formatearMonto(totales['retiros-cuotas'])}`;
                document.getElementById('total-desembolsos').textContent = `$${Utilidades.formatearMonto(totales.desembolsos)}`;
                
                const egresoTotal = Object.values(totales).reduce((sum, total) => sum + total, 0);
                document.getElementById('total-egreso').textContent = `$${Utilidades.formatearMonto(egresoTotal)}`;
            },

            inicializarEventos() {
                // Eventos de fecha
                document.getElementById('fechaSelector').addEventListener('change', () => {
                    this.aplicarFiltroFecha();
                    this.cargarTodasTablas();
                    this.actualizarTotales();
                });

                document.querySelector('.btn-hoy').addEventListener('click', () => {
                    document.getElementById('fechaSelector').value = Utilidades.formatearFechaParaInput(new Date());
                    this.aplicarFiltroFecha();
                    this.cargarTodasTablas();
                    this.actualizarTotales();
                });

                // Eventos de paginación
                CONFIG.tipos.forEach(tipo => {
                    document.querySelector(`.btn-prev-${tipo}`).addEventListener('click', () => {
                        if (estado.paginas[tipo] > 1) {
                            estado.paginas[tipo]--;
                            this.cargarTabla(tipo);
                        }
                    });

                    document.querySelector(`.btn-next-${tipo}`).addEventListener('click', () => {
                        const totalPaginas = Math.ceil(estado.filtrados[tipo].length / CONFIG.registrosPorPagina);
                        if (estado.paginas[tipo] < totalPaginas) {
                            estado.paginas[tipo]++;
                            this.cargarTabla(tipo);
                        }
                    });
                });

                // Búsquedas
                CONFIG.tipos.forEach(tipo => {
                    document.getElementById(`search${capitalize(tipo)}`)
                        .addEventListener('input', (e) => this.filtrarTabla(tipo, e.target.value));
                });

                // Botones de acción
                document.querySelector('.btn-generar-pdf').addEventListener('click', () => 
                    this.descargarPDF(document.getElementById('fechaSelector').value));

                document.querySelector('.btn-nuevo-gastos-empresa').addEventListener('click', () => 
                    this.registrarGasto('Empresa'));

                document.querySelector('.btn-nuevo-gastos-varios').addEventListener('click', () => 
                    this.registrarGasto('Varios'));
                    
                document.querySelector('.btn-nuevo-retiros-cuotas').addEventListener('click', () => 
                    this.registrarGasto('Retiro de Cuotas'));
            },

            filtrarTabla(tipo, filtro) {
                if (filtro.trim() === '') {
                    this.aplicarFiltroFecha();
                } else {
                    let datosBase;
                    if (tipo === 'desembolsos') {
                        datosBase = estado.datos.desembolsos;
                    } else {
                        const tipoGasto = tipo === 'gastos-empresa' ? 'Empresa' : 
                                         tipo === 'gastos-varios' ? 'Varios' : 'Retiro de Cuotas';
                        datosBase = estado.datos.gastos.filter(gasto => gasto.tipo === tipoGasto);
                    }
                    
                    estado.filtrados[tipo] = datosBase.filter(item => {
                        const fechaItem = tipo === 'desembolsos' ? item.fechaDesembolsado : item.fecha;
                        if (!fechaItem) return false;
                        const fechaFiltrada = Utilidades.formatearFechaParaInput(new Date(fechaItem)) === estado.fechaSeleccionada;
                        
                        if (tipo === 'desembolsos') {
                            const nombre = `${item.usuario?.nombre || ''} ${item.usuario?.apellido || ''}`.toLowerCase();
                            return fechaFiltrada && (
                                nombre.includes(filtro.toLowerCase()) ||
                                (item.usuario?.dui && item.usuario.dui.toLowerCase().includes(filtro)) ||
                                (item.monto && item.monto.toString().includes(filtro))
                            );
                        }
                        
                        return fechaFiltrada && (
                            (item.motivo && item.motivo.toLowerCase().includes(filtro.toLowerCase())) ||
                            (item.monto && item.monto.toString().includes(filtro))
                        );
                    });
                }

                estado.paginas[tipo] = 1;
                this.cargarTabla(tipo);
                this.actualizarTotales();
            },

            descargarPDF(fecha) {
                fetch(`/admin/pdf/reporte/${fecha}/egresos`, { method: 'POST' })
                    .then(res => { if (!res.ok) throw new Error('Error al generar PDF'); return res.blob(); })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `reporte-egresos-${fecha}.pdf`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    })
                    .catch(() => Swal.fire('Error', 'No se pudo generar el PDF', 'error'));
            },

            registrarGasto(tipo) {
                Swal.fire({
                    title: `Registrar Nuevo Gasto - ${tipo}`,
                    showConfirmButton: true,
                    confirmButtonText: '<i class="fas fa-receipt"></i> Registrar Gasto',
                    showCancelButton: true,
                    html: `
                        <div>
                            <div class="mb-3">
                                <label for="monto" class="form-label">Monto del Gasto</label>
                                <input type="number" step="0.01" class="form-control" id="monto" required>
                            </div>
                            <div class="mb-3">
                                <label for="motivo" class="form-label">Motivo</label>
                                <textarea class="form-control" id="motivo" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="fechaEgreso" class="form-label">Fecha de Egreso</label>
                                <input type="date" class="form-control" id="fechaEgreso" name="fechaEgreso" value="${Utils.formatDateForInput(new Date)}" required>
                            </div>
                            <p style="font-size: 0.8em; color: #666; margin-top: 10px;">
                                Registrando gasto como: <strong>${tipo}</strong>
                            </p>
                        </div>
                    `,
                    preConfirm: () => {
                        const monto = document.getElementById('monto').value.trim();
                        const motivo = document.getElementById('motivo').value.trim();
                        const fechaEl = document.getElementById('fechaEgreso');
                        const fecha = fechaEl ? fechaEl.value.trim() : '';

                        
                        if (!monto || isNaN(monto) || Number(monto) <= 0) {
                            Swal.showValidationMessage('Ingrese un monto válido mayor que 0');
                            return false;
                        }
                        if (!motivo) {
                            Swal.showValidationMessage('Motivo es requerido');
                            return false;
                        }
                        if (!fecha) {
                            Swal.showValidationMessage('Fecha de egreso es requerida');
                            return false;
                        }
                        return { monto, motivo, fecha, tipo };
                    }
                }).then((result) => {
                    if (!result.isConfirmed) return;
                    
                    Swal.fire({
                        title: 'Confirmar Gasto',
                        text: `¿Estás seguro que quieres registrar un gasto de $${result.value.monto} como ${tipo} la fecha ${result.value.fecha}?`,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Sí, registrar'
                    }).then(conf => {
                        if (!conf.isConfirmed) return;
                        
                        fetch('/admin/gasto', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(result.value)
                        })
                            .then(res => { if (!res.ok) throw new Error(); return res; })
                            .then(() => { 
                                Swal.fire({ icon: 'success', title: 'Gasto registrado' });
                                setTimeout(() => location.reload(), 700);
                            })
                            .catch(() => Swal.fire({ icon: 'error', title: 'No se pudo registrar el gasto' }));
                    });
                });
            }
        };

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => RegistroEgresos.inicializar());
    </script>
</th:block>
</body>
</html>