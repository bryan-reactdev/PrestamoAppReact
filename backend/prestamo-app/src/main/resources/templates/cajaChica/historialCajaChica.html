<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{appDashboard/admin/layout :: layout(
          pageTitle='',
          pageSubtitle='',
          activePage='cajaChica',
          content=~{::content},
          pageCss=~{::css},
          pageScripts=~{::scripts}
      )}">
<head>
    <th:block th:fragment="css">
        <link rel="stylesheet" type="text/css" th:href="@{/css/RegistroIngresos.css}" />


    </th:block>
</head>
<body>
<div th:fragment="content">
    <!-- Cabecera con controles -->
    <div class="dashboard-header">
        <div class="header-content">
            <div class="total-card total-general">
                <div class="total-controls">
                    <div class="date-controls">
                        <div class="date-selector">
                            <label for="fechaSelector">Fecha:</label>
                            <input type="date" id="fechaSelector" class="form-control">
                        </div>
                        <button class="btn btn-primary btn-hoy">
                            <i class="fas fa-rotate"></i> Hoy
                        </button>
                    </div>
                    <button class="btn btn-danger btn-generar-pdf">
                        <i class="fas fa-file-pdf"></i> Generar PDF
                    </button>
                </div>
                <div class="total-main-content">
                    <div class="balance-icon">
                        <i class="fas fa-piggy-bank"></i>
                    </div>
                    <div class="total-content">
                        <div class="balance-label">Balance Actual (Hoy)</div>
                        <div class="balance-amount" id="balance-actual">$0.00</div>
                        <div class="balance-date" id="fecha-balance-actual"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-container">
        <div class="tabs-header">
            <button class="tab-button active" data-tab="balance">
                <i class="fas fa-chart-line"></i>
                Resumen de Balance
            </button>
            <button class="tab-button" data-tab="ingresos-egresos">
                <i class="fas fa-exchange-alt"></i>
                Historial de Ingresos y Egresos
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="tab-content active" id="tab-balance">
            <!-- Sección de Historial de Balance -->
            <div class="section-container">
                <div class="section-header">
                    <h2><i class="fas fa-history"></i> Historial de Balance</h2>
                    <div class="section-actions">
                        <div class="search-box">
                            <input type="text" id="searchBalance" placeholder="Buscar en historial..." class="form-control">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table" id="tablaBalance">
                        <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Balance del Día</th>
                            <th>Ingresos Totales</th>
                            <th>Egresos Totales</th>
                        </tr>
                        </thead>
                        <tbody id="tbodyBalance">
                        <!-- Los datos se cargarán dinámicamente via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="table-footer">
                    <div class="table-info">
                        Mostrando <span id="balanceCount">0</span> registros de <span id="totalBalanceCount">0</span>
                    </div>
                    <div class="pagination-controls" id="paginacionBalance">
                        <button class="btn btn-sm btn-outline-secondary btn-prev-balance" disabled>
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-info">Página <span id="paginaActualBalance">1</span> de <span id="totalPaginasBalance">1</span></span>
                        <button class="btn btn-sm btn-outline-secondary btn-next-balance" disabled>
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="tab-ingresos-egresos">
            <!-- Sección de Historial de Ingresos y Egresos -->
            <div class="section-container">
                <div class="section-header">
                    <h2><i class="fas fa-exchange-alt"></i> Historial de Ingresos y Egresos</h2>
                    <div class="section-actions">
                        <div class="search-box">
                            <input type="text" id="searchIngresosEgresos" placeholder="Buscar en ingresos y egresos..." class="form-control">
                            <i class="fas fa-search"></i>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="data-table" id="tablaIngresosEgresos">
                        <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Tipo</th>
                            <th>Procedencia</th>
                            <th>Monto</th>
                        </tr>
                        </thead>
                        <tbody id="tbodyIngresosEgresos">
                        <!-- Los datos se cargarán dinámicamente via JavaScript -->
                        </tbody>
                    </table>
                </div>

                <div class="table-footer">
                    <div class="table-info">
                        Mostrando <span id="ingresosEgresosCount">0</span> registros de <span id="totalIngresosEgresosCount">0</span>
                    </div>
                    <div class="pagination-controls" id="paginacionIngresosEgresos">
                        <button class="btn btn-sm btn-outline-secondary btn-prev-ingresos-egresos" disabled>
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-info">Página <span id="paginaActualIngresosEgresos">1</span> de <span id="totalPaginasIngresosEgresos">1</span></span>
                        <button class="btn btn-sm btn-outline-secondary btn-next-ingresos-egresos" disabled>
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:fragment="scripts">
    <script th:inline="javascript">
        // Configuración centralizada
        const CONFIG = {
            registrosPorPagina: 10,
            fechaActual: new Date()
        };

        // Estado de la aplicación
        const estado = {
            fechaSeleccionada: null,
            datos: {
                historialBalance: /*[[${historialBalance}]]*/ [],
                balanceActual: /*[[${balance}]]*/ { saldo: 0 },
                ingresosTotales: /*[[${ingresosTotales}]]*/ 0,
                egresosTotales: /*[[${egresosTotales}]]*/ 0,
                creditosDesembolsados: /*[[${creditosDesembolsados}]]*/ [],
                cuotasPagadas: /*[[${cuotasPagadas}]]*/ [],
                cajaGastos: /*[[${cajaGastos}]]*/ [],
                cajaIngresos: /*[[${cajaIngresos}]]*/ []  // Add this line
            },
            filtrados: {
                balance: [],
                ingresosEgresos: []
            },
            paginas: {
                balance: 1,
                ingresosEgresos: 1
            },
            tabActiva: 'balance'
        };

        // Utilidades
        const Utilidades = {
            formatearFechaParaInput: (fecha) => {
                if (typeof fecha === 'string' && fecha.match(/^\d{4}-\d{2}-\d{2}$/)) return fecha;
                const d = new Date(fecha);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            },

            formatearFechaCompleta: (fechaString) => {
                if (!fechaString) return 'N/A';
                try {
                    const fecha = new Date(fechaString);
                    return fecha.toLocaleDateString('es-ES', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                } catch (e) {
                    return 'N/A';
                }
            },

            formatearFechaSimple: (fechaString) => {
                if (!fechaString) return 'N/A';
                try {
                    const fecha = new Date(fechaString);
                    return fecha.toLocaleDateString('es-ES');
                } catch (e) {
                    return 'N/A';
                }
            },

            formatearMonto: (monto) => parseFloat(monto).toFixed(2)
        };

        // Tabs functionality
        const TabsManager = {
            inicializar() {
                this.inicializarEventos();
            },

            inicializarEventos() {
                // Tab click events
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const tabId = e.currentTarget.getAttribute('data-tab');
                        this.cambiarTab(tabId);
                    });
                });
            },

            cambiarTab(tabId) {
                // Update active tab button
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');

                // Update active tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`tab-${tabId}`).classList.add('active');

                // Update state
                estado.tabActiva = tabId;
            }
        };

        // Lógica principal
        const BalanceManager = {
            inicializar() {
                this.inicializarUI();
                this.aplicarFiltroFecha();
                this.cargarTodasTablas();
                this.actualizarBalanceActual();
                this.inicializarEventos();
                TabsManager.inicializar();
            },

            inicializarUI() {
                // Configurar fecha
                const fechaSelector = document.getElementById('fechaSelector');
                estado.fechaSeleccionada = Utilidades.formatearFechaParaInput(CONFIG.fechaActual);
                fechaSelector.value = estado.fechaSeleccionada;

                // Configurar fecha actual en el balance
                const fechaBalanceEl = document.getElementById('fecha-balance-actual');
                fechaBalanceEl.textContent = Utilidades.formatearFechaCompleta(CONFIG.fechaActual);
            },

            aplicarFiltroFecha() {
                const fechaInput = document.getElementById('fechaSelector').value;
                if (!fechaInput) return;
                
                estado.fechaSeleccionada = fechaInput;
                
                // Filtrar balance por fecha seleccionada
                estado.filtrados.balance = estado.datos.historialBalance.filter(registro => {
                    if (!registro.fecha) return false;
                    const fechaRegistro = Utilidades.formatearFechaParaInput(new Date(registro.fecha));
                    return fechaRegistro === estado.fechaSeleccionada;
                });

                // Filtrar ingresos y egresos por fecha seleccionada
                estado.filtrados.ingresosEgresos = this.obtenerIngresosEgresosPorFecha(estado.fechaSeleccionada);

                estado.paginas.balance = 1;
                estado.paginas.ingresosEgresos = 1;
            },

            obtenerIngresosEgresosPorFecha(fecha) {
                const ingresosEgresos = [];

                // Créditos Desembolsados (Egresos)
                estado.datos.creditosDesembolsados.forEach(credito => {
                    if (credito.fechaDesembolsado && Utilidades.formatearFechaParaInput(new Date(credito.fechaDesembolsado)) === fecha) {
                        ingresosEgresos.push({
                            fecha: credito.fechaDesembolsado,
                            tipo: 'Egreso',
                            procedencia: 'Crédito Desembolsado',
                            monto: credito.montoDado || credito.monto || 0
                        });
                    }
                });

                // Cuotas Pagadas (Ingresos)
                estado.datos.cuotasPagadas.forEach(cuota => {
                    if (cuota.fechaPago && Utilidades.formatearFechaParaInput(new Date(cuota.fechaPago)) === fecha) {
                        ingresosEgresos.push({
                            fecha: cuota.fechaPago,
                            tipo: 'Ingreso',
                            procedencia: 'Pago de Cuota',
                            monto: cuota.total || 0
                        });
                    }
                });

                // Gastos (Egresos)
                estado.datos.cajaGastos.forEach(gasto => {
                    if (gasto.fecha && Utilidades.formatearFechaParaInput(new Date(gasto.fecha)) === fecha) {
                        const tipoGasto = gasto.tipo || 'Gasto Varios';
                        ingresosEgresos.push({
                            fecha: gasto.fecha,
                            tipo: 'Egreso',
                            procedencia: tipoGasto,
                            monto: gasto.monto || 0
                        });
                    }
                });

                // Ingresos de Caja (Capital, Varios, etc.)
                estado.datos.cajaIngresos.forEach(ingreso => {
                    if (ingreso.fecha && Utilidades.formatearFechaParaInput(new Date(ingreso.fecha)) === fecha) {
                        const tipoIngreso = ingreso.tipo || 'Ingreso Varios';
                        ingresosEgresos.push({
                            fecha: ingreso.fecha,
                            tipo: 'Ingreso',
                            procedencia: tipoIngreso,
                            monto: ingreso.monto || 0
                        });
                    }
                });

                // Ordenar por fecha y hora (más reciente primero) - usando el objeto Date completo
                return ingresosEgresos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            },

            cargarTodasTablas() {
                this.cargarTablaBalance();
                this.cargarTablaIngresosEgresos();
            },

            cargarTablaBalance() {
                const tbody = document.getElementById('tbodyBalance');
                const datos = estado.filtrados.balance;
                const esHoy = estado.fechaSeleccionada === Utilidades.formatearFechaParaInput(CONFIG.fechaActual);

                if (datos.length === 0 && !esHoy) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                <i class="fas fa-inbox"></i> No hay registros de balance para esta fecha
                            </td>
                        </tr>
                    `;
                    this.actualizarContadoresBalance(0, 0);
                    this.actualizarPaginacionBalance();
                    return;
                }

                const inicio = (estado.paginas.balance - 1) * CONFIG.registrosPorPagina;
                const datosPaginados = datos.slice(inicio, inicio + CONFIG.registrosPorPagina);

                let html = '';

                // Add today's row if viewing today's date
                if (esHoy) {
                    const balanceHoy = estado.datos.balanceActual.saldo || 0;
                    const ingresosHoy = estado.datos.ingresosTotales || 0;
                    const egresosHoy = estado.datos.egresosTotales || 0;

                    html += `
                        <tr class="today-row">
                            <td>
                                <strong>${Utilidades.formatearFechaCompleta(CONFIG.fechaActual)}</strong>
                                <span class="badge badge-primary ml-2">Hoy</span>
                            </td>
                            <td>
                                <span class="${balanceHoy >= 0 ? 'text-success' : 'text-danger'}">
                                    <strong>$${Utilidades.formatearMonto(balanceHoy)}</strong>
                                </span>
                            </td>
                            <td class="text-success">
                                <strong>+$${Utilidades.formatearMonto(ingresosHoy)}</strong>
                            </td>
                            <td class="text-danger">
                                <strong>-$${Utilidades.formatearMonto(egresosHoy)}</strong>
                            </td>
                        </tr>
                    `;
                }

                // Add historical data
                datosPaginados.forEach(registro => {
                    const balance = registro.monto || 0;
                    const ingresos = registro.ingresosTotales || 0;
                    const egresos = registro.egresosTotales || 0;

                    html += `
                        <tr>
                            <td>${Utilidades.formatearFechaCompleta(registro.fecha)}</td>
                            <td>
                                <span class="${balance >= 0 ? 'text-success' : 'text-danger'}">
                                    $${Utilidades.formatearMonto(balance)}
                                </span>
                            </td>
                            <td class="text-success">+$${Utilidades.formatearMonto(ingresos)}</td>
                            <td class="text-danger">-$${Utilidades.formatearMonto(egresos)}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                
                // Update counters (include today's row in count if applicable)
                const totalMostrados = datosPaginados.length + (esHoy ? 1 : 0);
                const totalRegistros = datos.length + (esHoy ? 1 : 0);
                
                this.actualizarContadoresBalance(totalMostrados, totalRegistros);
                this.actualizarPaginacionBalance();
            },

            cargarTablaIngresosEgresos() {
                const tbody = document.getElementById('tbodyIngresosEgresos');
                const datos = estado.filtrados.ingresosEgresos;

                console.log('Datos para tabla ingresos/egresos:', datos); // Debug log

                if (datos.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-muted">
                                <i class="fas fa-inbox"></i> No hay registros de ingresos y egresos para esta fecha
                            </td>
                        </tr>
                    `;
                    this.actualizarContadoresIngresosEgresos(0, 0);
                    this.actualizarPaginacionIngresosEgresos();
                    return;
                }

                const inicio = (estado.paginas.ingresosEgresos - 1) * CONFIG.registrosPorPagina;
                const datosPaginados = datos.slice(inicio, inicio + CONFIG.registrosPorPagina);

                let html = '';

                datosPaginados.forEach(registro => {
                    const esIngreso = registro.tipo === 'Ingreso';
                    const claseMonto = esIngreso ? 'text-success' : 'text-danger';
                    const simboloMonto = esIngreso ? '+' : '-';

                    console.log('Procesando registro:', registro); // Debug log

                    html += `
                        <tr>
                            <td>${Utilidades.formatearFechaSimple(registro.fecha)}</td>
                            <td>
                                <span class="badge ${esIngreso ? 'badge-success' : 'badge-danger'}">
                                    ${registro.tipo}
                                </span>
                            </td>
                            <td>${registro.procedencia}</td>
                            <td class="${claseMonto}">
                                ${simboloMonto}$${Utilidades.formatearMonto(registro.montoDado || registro.monto || 0)}
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
                this.actualizarContadoresIngresosEgresos(datosPaginados.length, datos.length);
                this.actualizarPaginacionIngresosEgresos();
            },

            actualizarContadoresBalance(mostrados, total) {
                document.getElementById('balanceCount').textContent = mostrados;
                document.getElementById('totalBalanceCount').textContent = total;
            },

            actualizarContadoresIngresosEgresos(mostrados, total) {
                document.getElementById('ingresosEgresosCount').textContent = mostrados;
                document.getElementById('totalIngresosEgresosCount').textContent = total;
            },

            actualizarPaginacionBalance() {
                const totalPaginas = Math.ceil(estado.filtrados.balance.length / CONFIG.registrosPorPagina);
                const elementos = {
                    prev: document.querySelector('.btn-prev-balance'),
                    next: document.querySelector('.btn-next-balance'),
                    actual: document.getElementById('paginaActualBalance'),
                    total: document.getElementById('totalPaginasBalance')
                };

                elementos.actual.textContent = estado.paginas.balance;
                elementos.total.textContent = totalPaginas;
                elementos.prev.disabled = estado.paginas.balance <= 1;
                elementos.next.disabled = estado.paginas.balance >= totalPaginas;
            },

            actualizarPaginacionIngresosEgresos() {
                const totalPaginas = Math.ceil(estado.filtrados.ingresosEgresos.length / CONFIG.registrosPorPagina);
                const elementos = {
                    prev: document.querySelector('.btn-prev-ingresos-egresos'),
                    next: document.querySelector('.btn-next-ingresos-egresos'),
                    actual: document.getElementById('paginaActualIngresosEgresos'),
                    total: document.getElementById('totalPaginasIngresosEgresos')
                };

                elementos.actual.textContent = estado.paginas.ingresosEgresos;
                elementos.total.textContent = totalPaginas;
                elementos.prev.disabled = estado.paginas.ingresosEgresos <= 1;
                elementos.next.disabled = estado.paginas.ingresosEgresos >= totalPaginas;
            },

            actualizarBalanceActual() {
                const balanceActualEl = document.getElementById('balance-actual');
                const saldoActual = estado.datos.balanceActual.saldo || 0;
                balanceActualEl.textContent = `$${Utilidades.formatearMonto(saldoActual)}`;
                
                // Aplicar estilo según si es positivo o negativo
                if (saldoActual >= 0) {
                    balanceActualEl.className = 'balance-amount positive';
                } else {
                    balanceActualEl.className = 'balance-amount negative';
                }
            },

            inicializarEventos() {
                // Eventos de fecha
                document.getElementById('fechaSelector').addEventListener('change', () => {
                    this.aplicarFiltroFecha();
                    this.cargarTodasTablas();
                });

                document.querySelector('.btn-hoy').addEventListener('click', () => {
                    document.getElementById('fechaSelector').value = Utilidades.formatearFechaParaInput(new Date());
                    this.aplicarFiltroFecha();
                    this.cargarTodasTablas();
                });

                // Eventos de paginación para balance
                document.querySelector('.btn-prev-balance').addEventListener('click', () => {
                    if (estado.paginas.balance > 1) {
                        estado.paginas.balance--;
                        this.cargarTablaBalance();
                    }
                });

                document.querySelector('.btn-next-balance').addEventListener('click', () => {
                    const totalPaginas = Math.ceil(estado.filtrados.balance.length / CONFIG.registrosPorPagina);
                    if (estado.paginas.balance < totalPaginas) {
                        estado.paginas.balance++;
                        this.cargarTablaBalance();
                    }
                });

                // Eventos de paginación para ingresos y egresos
                document.querySelector('.btn-prev-ingresos-egresos').addEventListener('click', () => {
                    if (estado.paginas.ingresosEgresos > 1) {
                        estado.paginas.ingresosEgresos--;
                        this.cargarTablaIngresosEgresos();
                    }
                });

                document.querySelector('.btn-next-ingresos-egresos').addEventListener('click', () => {
                    const totalPaginas = Math.ceil(estado.filtrados.ingresosEgresos.length / CONFIG.registrosPorPagina);
                    if (estado.paginas.ingresosEgresos < totalPaginas) {
                        estado.paginas.ingresosEgresos++;
                        this.cargarTablaIngresosEgresos();
                    }
                });

                // Búsquedas
                document.getElementById('searchBalance').addEventListener('input', (e) => {
                    this.filtrarTablaBalance(e.target.value);
                });

                document.getElementById('searchIngresosEgresos').addEventListener('input', (e) => {
                    this.filtrarTablaIngresosEgresos(e.target.value);
                });

                // Botón generar PDF
                document.querySelector('.btn-generar-pdf').addEventListener('click', () => {
                    this.descargarPDF(document.getElementById('fechaSelector').value);
                });
            },

            filtrarTablaBalance(filtro) {
                if (filtro.trim() === '') {
                    this.aplicarFiltroFecha();
                } else {
                    estado.filtrados.balance = estado.datos.historialBalance.filter(registro => {
                        const fechaRegistro = Utilidades.formatearFechaParaInput(new Date(registro.fecha));
                        const fechaFiltrada = fechaRegistro === estado.fechaSeleccionada;
                        
                        const fechaFormateada = Utilidades.formatearFechaCompleta(registro.fecha).toLowerCase();
                        const balance = (registro.monto || 0).toString();
                        const ingresos = (registro.ingresosTotales || 0).toString();
                        const egresos = (registro.egresosTotales || 0).toString();
                        
                        return fechaFiltrada && (
                            fechaFormateada.includes(filtro.toLowerCase()) ||
                            balance.includes(filtro) ||
                            ingresos.includes(filtro) ||
                            egresos.includes(filtro)
                        );
                    });
                }

                estado.paginas.balance = 1;
                this.cargarTablaBalance();
            },

            filtrarTablaIngresosEgresos(filtro) {
                if (filtro.trim() === '') {
                    this.aplicarFiltroFecha();
                } else {
                    estado.filtrados.ingresosEgresos = this.obtenerIngresosEgresosPorFecha(estado.fechaSeleccionada)
                        .filter(registro => {
                            const fechaFormateada = Utilidades.formatearFechaSimple(registro.fecha).toLowerCase();
                            const tipo = registro.tipo.toLowerCase();
                            const procedencia = registro.procedencia.toLowerCase();
                            const monto = (registro.monto || 0).toString();
                            
                            return (
                                fechaFormateada.includes(filtro.toLowerCase()) ||
                                tipo.includes(filtro.toLowerCase()) ||
                                procedencia.includes(filtro.toLowerCase()) ||
                                monto.includes(filtro)
                            );
                        });
                }

                estado.paginas.ingresosEgresos = 1;
                this.cargarTablaIngresosEgresos();
            },

            descargarPDF(fecha) {
                const params = new URLSearchParams({
                    fecha: fecha
                });

                fetch(`/admin/pdf/reporte/balance?${params}`, {
                    method: 'POST'
                })
                    .then(res => {
                        if (!res.ok) throw new Error('Error al generar PDF');
                        return res.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.style.display = 'none';
                        a.href = url;
                        a.download = `reporte-balance-${fecha}.pdf`;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);

                        // Registrar acción en el sistema
                        this.registrarAccion('DESCARGADO_REPORTE_PDF_BALANCE');
                    })
                    .catch(error => {
                        console.error('PDF generation error:', error);
                        Swal.fire('Error', 'No se pudo generar el PDF', 'error');
                    });
            },

            registrarAccion(tipoAccion) {
                fetch('/admin/accion-usuario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accion: tipoAccion })
                }).catch(err => console.error('Error registrando acción:', err));
            }
        };

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', () => BalanceManager.inicializar());
    </script>

    <style>
        .balance-actual-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
        }
        
        .balance-card {
            color: white;
            padding: 25px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .balance-icon {
            font-size: 3rem;
            margin-right: 20px;
            opacity: 0.9;
        }
        
        .balance-content {
            flex: 1;
        }
        
        .balance-label {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        
        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .balance-amount.positive {
            color: #28a745;
        }
        
        .balance-amount.negative {
            color: #dc3545;
        }
        
        .balance-date {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .date-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .text-success {
            color: #28a745 !important;
            font-weight: bold;
        }
        
        .text-danger {
            color: #dc3545 !important;
            font-weight: bold;
        }
        
        .today-row {
            background-color: rgba(0, 123, 255, 0.05) !important;
            border-left: 4px solid #007bff;
        }
        
        .today-row td {
            font-weight: 600;
        }
        
        .badge {
            font-size: 0.7em;
            padding: 3px 6px;
        }
        
        .ml-2 {
            margin-left: 0.5rem;
        }
    </style>
</th:block>
</body>
</html>