<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- Mensajes leidos Table -->
<div th:fragment="leidos-table-content(mensajes)">
    <div class="table-wrapper">
        <div id="leidosTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Fecha de Mensaje</th>
                    <th>Tipo de Préstamo</th>
                    <th>Acciones</th>
                </thead>
                <tbody th:if="${not #lists.isEmpty(mensajes)}" th:each="mensaje : ${mensajes}">
                    <tr>
                        <td th:text="${mensaje.nombre}"></td>
                        <td th:text="${mensaje.email}"></td>
                        <td th:text="${mensaje.telefono}"></td>
                        <td th:text="${mensaje.fecha}"></td>
                        <td th:text="${mensaje.tipo}"></td>
                        <td th:if="${usuario.rol != 'ROLE_COBRADOR'}">
                            <button class="btn btn-neutral btn-sm"
                                    th:data-id="${mensaje.id}"
                                    th:data-nombre="${mensaje.nombre}"
                                    th:data-telefono="${mensaje.telefono}"
                                    onclick="marcarComo('no-leido', this)"> 
                                <i class="fas fa-eye-slash"></i> Marcar como no Leído
                            </button>
                            <a
                                th:href="'https://wa.me/' + ${#strings.replace(mensaje.telefono, ' ', '')} + '?text=' + ${'Hola ' + mensaje.nombre + ', es un gusto contactarnos con usted.'}"
                                class="btn btn-success btn-sm rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                                style="width: 42px; height: 42px; padding: 0;"
                                target="_blank"
                                title="Contactar por WhatsApp">
                                    <i class="fab fa-whatsapp" style="font-size: 30px;"></i>
                            </a>
                        </td>
                    </tr>
                </tbody>
                <tbody th:if="${#lists.isEmpty(mensajes)}">
                <tr>
                    <td colspan=6 class="text-center text-muted">No hay mensajes</td>
                </tr>
                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>
</div>

<!-- Mensajes no leidos Table -->
<div th:fragment="no-leidos-table-content(mensajes)">
    <div class="table-wrapper">
        <div id="noLeidosTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Fecha de Mensaje</th>
                    <th>Tipo de Préstamo</th>
                    <th>Acciones</th>
                </thead>
                <tbody th:if="${not #lists.isEmpty(mensajes)}" th:each="mensaje : ${mensajes}">
                    <tr>
                        <td th:text="${mensaje.nombre}"></td>
                        <td th:text="${mensaje.email}"></td>
                        <td th:text="${mensaje.telefono}"></td>
                        <td th:text="${mensaje.fecha}"></td>
                        <td th:text="${mensaje.tipo}"></td>
                        <td th:if="${usuario.rol != 'ROLE_COBRADOR'}">
                            <button class="btn btn-neutral btn-sm"
                                    th:data-id="${mensaje.id}"
                                    th:data-nombre="${mensaje.nombre}"
                                    th:data-telefono="${mensaje.telefono}"
                                    onclick="marcarComo('leido', this)"> 
                                <i class="fas fa-eye"></i> Marcar como Leído
                            </button>
                            <a
                                th:href="'https://wa.me/' + ${#strings.replace(mensaje.telefono, ' ', '')} + '?text=' + ${'Hola ' + mensaje.nombre + ', es un gusto contactarnos con usted.'}"
                                class="btn btn-success btn-sm rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                                style="width: 42px; height: 42px; padding: 0;"
                                target="_blank"
                                title="Contactar por WhatsApp">
                                    <i class="fab fa-whatsapp" style="font-size: 30px;"></i>
                            </a>
                        </td>
                    </tr>
                </tbody>
                <tbody th:if="${#lists.isEmpty(mensajes)}">
                <tr>
                    <td colspan=6 class="text-center text-muted">No hay mensajes</td>
                </tr>
                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>

    <th:block th:fragment="scripts">
        <script>
            function marcarComo(tipo, button) {
            const mensajeId = button.getAttribute('data-id');
            const mensajeNombre = button.getAttribute('data-nombre');
            const mensajeTelefono = button.getAttribute('data-telefono');
            const row = button.closest('tr');
            const tableContainer = row.closest('.table-switchable-table');
            const tableId = tableContainer.id;

            console.log('/mensajes/' + tipo + '/' + mensajeId);
            Swal.fire({
                title: (tipo === 'leido' ? '¿Marcar como leído?' : '¿Marcar como no leído?'),
                text: (tipo === 'leido' 
                    ? "¿Estás seguro de que deseas marcar este mensaje como leído?" 
                    : "¿Estás seguro de que deseas marcar este mensaje como no leído?"),
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, marcarlo',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    row.style.opacity = '0.5';

                    fetch('/mensajes/' + tipo + '/' + mensajeId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire(
                                '¡Marcado!',
                                (tipo === 'leido' 
                                    ? 'El mensaje ha sido marcado como leído.' 
                                    : 'El mensaje ha sido marcado como no leído.'),
                                'success'
                            ).then(() => {
                                row.style.opacity = '1';

                                // Move the row to the other table
                                const targetTableId = (tableId === 'leidosTable') ? 'noLeidosTable' : 'leidosTable';
                                const targetTable = document.getElementById(targetTableId);
                                const targetTbody = targetTable.querySelector('tbody');
                                
                                // Clone the row and update its button
                                const newRow = row.cloneNode(true);
                                const buttonCell = newRow.querySelector('td:last-child');
                                
                                if (targetTableId === 'leidosTable') {
                                    buttonCell.innerHTML = `
                                        <button class="btn btn-neutral btn-sm"
                                                data-id="${mensajeId}"
                                                onclick="marcarComo('no-leido', this)"> 
                                            <i class="fas fa-eye-slash"></i> Marcar como no Leído
                                        </button>

                                        <a
                                            href="https://wa.me/${mensajeTelefono}?text=Hola ${mensajeNombre}, es un gusto contactarnos con usted."
                                            class="btn btn-success btn-sm rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                                            style="width: 42px; height: 42px; padding: 0;"
                                            target="_blank"
                                            title="Contactar por WhatsApp">
                                                <i class="fab fa-whatsapp" style="font-size: 30px;"></i>
                                        </a>
                                    `;
                                } else {
                                    buttonCell.innerHTML = `
                                        <button class="btn btn-neutral btn-sm"
                                                data-id="${mensajeId}"
                                                onclick="marcarComo('leido', this)"> 
                                            <i class="fas fa-eye"></i> Marcar como Leído
                                        </button>

                                        <a
                                            href="https://wa.me/${mensajeTelefono}?text=Hola ${mensajeNombre}, es un gusto contactarnos con usted.."
                                            class="btn btn-success btn-sm rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                                            style="width: 42px; height: 42px; padding: 0;"
                                            target="_blank"
                                            title="Contactar por WhatsApp">
                                                <i class="fab fa-whatsapp" style="font-size: 30px;"></i>
                                        </a>
                                    `;
                                }
                                
                                // Add the row to the target table
                                targetTbody.appendChild(newRow);
                                
                                // Remove the original row
                                row.remove();
                                
                                // Update pagination for both tables
                                setupPagination(document.getElementById(tableId), tableId);
                                setupPagination(targetTable, targetTableId);
                            });
                        } else {
                            Swal.fire(
                                'Error',
                                'Hubo un problema al marcar el mensaje.',
                                'error'
                            );
                            row.style.opacity = '1';
                        }
                    })
                    .catch(error => {
                        Swal.fire(
                            'Error',
                            'Hubo un problema al marcar el mensaje.',
                            'error'
                        );
                        row.style.opacity = '1';
                    });
                }
            });
        }
        </script>
    </th:block>

</div>

</html>
