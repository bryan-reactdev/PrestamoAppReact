<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Todos los creditos Table Fragment (scalable) -->
<div th:fragment="todos-table-content(creditos)">
    <div class="table-wrapper">
        <div id="todosTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th th:if="${usuario?.rol == 'ROLE_ADMIN'}">Usuario</th>
                    <th>Monto</th>
                    <th>Frecuencia de pago</th>
                    <th>Fecha de Solicitud</th>
                    <th>Total</th>
                    <th>Acción</th>
                </tr>
                </thead>
                <tbody th:if="${not #lists.isEmpty(creditos)}" th:each="credito : ${creditos}">
                <tr>
                    <td th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                        <img th:if="${credito.usuario?.foto != null}" th:src="${credito.usuario?.foto}" class="table-user-avatar" alt="User Image"/>
                        <span th:text="${credito.usuario?.nombre + ' ' + credito.usuario?.apellido}"></span>
                    </td>
                    <td th:text="${credito.monto}"></td>
                    <td th:text="${credito.plazoFrecuencia}"></td>
                    <td th:text="${credito.usuarioSolicitud != null ? #temporals.format(credito.usuarioSolicitud.fechaSolicitud, 'dd/MM/yyyy') : 'N/A'}"></td>
                    <td th:text="${credito.total}"></td>
                    <td>
                        <button class="btn btn-primary btn-sm" th:onclick="'showCreditoDetails(' + ${credito.id} + ')'">
                            <i class="fas fa-eye"></i> Ver detalles
                        </button>
                    </td>
                </tr>
                </tbody>
                <tbody th:if="${#lists.isEmpty(creditos)}">
                <tr>
                    <td th:colspan="${usuario?.rol == 'ROLE_ADMIN' ? 7 : 6}" class="text-center text-muted">No tienes créditos registrados</td>
                </tr>
                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>
</div>

<!-- Creditos aceptados Table -->
<div th:fragment="aceptados-table-content(creditos)">
    <div class="table-wrapper">
        <div id="aceptadosTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th>Calificación</th>
                    <th>Usuario</th>
                    <th>Monto</th>
                    <th>Monto A Dar</th>
                    <th>Frecuencia de pago</th>
                    <th>Fecha Aceptado</th>
                    <th>Desembolso</th>
                    <th>Acción</th>
                </tr>
                </thead>

                <tbody>
                <tr th:each="credito : ${creditos}">
                    <td th:class="${credito.calificacion.toString()}"
                        th:text="${credito.calificacion?.toString() == 'A_PLUS' ? 'A+' :
                                 (credito.calificacion?.toString() == 'D' ? 'Indeseable' : credito.calificacion?.toString())}">
                    </td>
                    <td>
                        <img th:if="${credito.usuario?.foto != null}" th:src="${credito.usuario?.foto}" class="table-user-avatar" alt="User Image"/>
                        <span th:text="${credito.usuario?.nombre + ' ' + credito.usuario?.apellido}"></span>
                    </td>
                    <td th:text="${credito.monto != null ? '$' + credito.monto : ''}"></td>
                    <td 
                        th:text="${credito.montoDado != null ? '$' + credito.montoDado : '$' + credito.monto}"
                        th:title="${credito.refinanciado} ? 'Motivo: Refinanciado' : ''"
                    ></td>
                    <td th:text="${credito.plazoFrecuencia}"></td>
                    <td th:text="${#temporals.format(credito.fechaAceptado, 'dd/MM/yyyy')}"></td>
                    <td>
                        <span th:text="${credito.desembolsado} ? ${#temporals.format(credito.fechaDesembolsado, 'dd/MM/yyyy')} : 'Pendiente'"
                            th:class="${credito.desembolsado} ? '' : 'badge bg-danger'"></span>
                    </td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                Acciones
                            </button>
                            <ul class="dropdown-menu p-2">
                                <li th:if="${(usuario?.rol == 'ROLE_ADMIN' or ((usuario?.rol == 'ROLE_SECRETARIA' or usuario?.rol == 'ROLE_GERENTE') and credito.desembolsable))}">
                                    <a class="dropdown-item" href="#" th:data-id="${credito.id}" th:data-user-full-name="${credito.usuario?.nombre + ' ' + credito.usuario?.apellido}" th:data-user-role="${usuario?.rol}" onclick="toggleDesembolso(this)">
                                        <i class="fas fa-money-bill-wave"></i>
                                        <span th:text="${credito.desembolsado} ? 'Revertir Desembolso' : 'Desembolsar'"></span>
                                    </a>
                                </li>
                                <li th:if="${(usuario?.rol == 'ROLE_ADMIN')}">
                                    <a class="dropdown-item" href="#" th:data-id="${credito.id}" th:data-capacidad-pago="${credito.capacidadPago}" th:data-historial-crediticio="${credito.historialCrediticio}" th:data-estabilidad-laboral="${credito.estabilidadLaboral}" th:data-nivel-endeudamiento="${credito.nivelEndeudamiento}" th:data-recomendacion="${credito.recomendacion}" onclick="mostrarAnalisisDeRiesgo(this)">
                                        <i class="fas fa-chart-line"></i>
                                        <span>Análisis de Riesgo</span>
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or ((usuario?.rol == 'ROLE_USER' or usuario?.rol == 'ROLE_SECRETARIA' or usuario?.rol == 'ROLE_GERENTE') and credito.descargable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'mostrarPDFModal(' + ${credito.id} + ')'">
                                        <i class="fas fa-file-pdf"></i> Generar Documentos
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol != 'ROLE_USER'}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/admin/usuarios/' + ${credito.usuario?.id} + '/creditos/' + ${credito.id} + '/cuotas\''">
                                        <i class="fas fa-calendar-alt"></i> Ver cuotas
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_USER'}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/usuario/credito/cuotas/' + ${credito.id} + '\''">
                                        <i class="fas fa-calendar-alt"></i> Ver cuotas
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or (usuario?.rol == 'ROLE_SECRETARIA' and credito.editable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/credito/edit/' + ${credito.id} + '\';'">
                                        <i class="fas fa-edit"></i> Editar Crédito
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                                    <a class="dropdown-item" href="#" th:onclick="'rechazarCredito(' + ${credito.id} + ')'">
                                        <i class="fas fa-times"></i> Enviar a Rechazados
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}" class="px-3 py-1">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" th:id="'toggleCreditoDescargable-' + ${credito.id}" th:checked="${credito.descargable}" th:onchange="'toggleCreditoDescargable(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCreditoDescargable-' + ${credito.id}">Descargable</label>
                                    </div>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" th:id="'toggleCredito-' + ${credito.id}" th:checked="${credito.editable}" th:onchange="'toggleCredito(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCredito-' + ${credito.id}">Editable</label>
                                    </div>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" th:id="'toggleCreditoDesembolsable-' + ${credito.id}" th:checked="${credito.desembolsable}" th:onchange="'toggleCreditoDesembolsable(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCreditoDesembolsable-' + ${credito.id}">Desembolsable</label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>

                <tr th:if="${#lists.isEmpty(creditos)}">
                    <td th:colspan="8"
                        class="text-center text-muted"
                        style="height: 550px !important; border-top: none;">
                        No hay créditos aceptados.
                    </td>
                </tr>


                <th:block th:unless="${#lists.isEmpty(creditos)}">
                    <th:block th:with="ROWS_PER_PAGE=10,
                                     COLUMNS=8,
                                     totalSize=${creditos.size()},
                                     remainder=${totalSize % ROWS_PER_PAGE},
                                     fillerRowsNeeded=${(remainder == 0 and totalSize > 0) ? 0 : ROWS_PER_PAGE - remainder}">

                        <tr th:if="${fillerRowsNeeded < ROWS_PER_PAGE}"
                            th:each="i : ${#numbers.sequence(1, fillerRowsNeeded)}"
                            style="height:55px;">

                            <th:block th:each="j : ${#numbers.sequence(1, COLUMNS)}">
                                <td style="border-top: none;">&nbsp;</td>
                            </th:block>
                        </tr>

                        <tr th:if="${remainder == 0 and totalSize > 0}" style="height:55px;">
                            <th:block th:each="j : ${#numbers.sequence(1, COLUMNS)}">
                                <td style="border-top: none; display: none;">&nbsp;</td>
                            </th:block>
                        </tr>
                    </th:block>
                </th:block>

                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>
</div>



<!-- Creditos pendientes Table -->
<div th:fragment="pendientes-table-content(creditos)">
    <div class="table-wrapper">
        <div id="pendientesTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th th:if="${usuario?.rol == 'ROLE_ADMIN'}">Usuario</th>
                    <th>Monto</th>
                    <th>Frecuencia de pago</th>
                    <th>Fecha de Solicitud</th>
                    <th>Acción</th>
                </tr>
                </thead>

                <tbody>

                <tr th:each="credito : ${creditos}">
                    <td th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                        <img th:if="${credito.usuario?.foto != null}" th:src="${credito.usuario?.foto}" class="table-user-avatar" alt="User Image"/>
                        <span th:text="${credito.usuario?.nombre + ' ' + credito.usuario?.apellido}"></span>
                    </td>
                    <td th:text="${credito.monto}"></td>
                    <td th:text="${credito.plazoFrecuencia}"></td>
                    <td th:text="${credito.usuarioSolicitud != null ? #temporals.format(credito.usuarioSolicitud.fechaSolicitud,'dd/MM/yyyy') : 'N/A'}"></td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Acciones
                            </button>
                            <ul class="dropdown-menu p-2">
                                <li th:if="${(usuario?.rol == 'ROLE_ADMIN')}">
                                    <a class="dropdown-item" href="#"
                                       th:data-id="${credito.id}"
                                       th:data-capacidad-pago="${credito.capacidadPago}"
                                       th:data-historial-crediticio="${credito.historialCrediticio}"
                                       th:data-estabilidad-laboral="${credito.estabilidadLaboral}"
                                       th:data-nivel-endeudamiento="${credito.nivelEndeudamiento}"
                                       th:data-recomendacion="${credito.recomendacion}"
                                       onclick="mostrarAnalisisDeRiesgo(this)">
                                        <i class="fas fa-chart-line"></i>
                                        <span>Análisis de Riesgo</span>
                                    </a>
                                </li>

                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or ((usuario?.rol == 'ROLE_USER' or usuario?.rol == 'ROLE_SECRETARIA') and credito.descargable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'mostrarPDFModal(' + ${credito.id} + ')'">
                                        <i class="fas fa-file-pdf"></i> Generar Documentos
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                                    <a class="dropdown-item" href="#" th:onclick="'aceptarCreditoConCargos(' + ${credito.id} + ')'">
                                        <i class="fas fa-check"></i> Aceptar
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                                    <a class="dropdown-item" href="#" th:onclick="'rechazarCredito(' + ${credito.id} + ')'">
                                        <i class="fas fa-times"></i> Rechazar
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or (usuario?.rol == 'ROLE_SECRETARIA' and credito.editable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/credito/edit/' + ${credito.id} + '\';'">
                                        <i class="fas fa-edit"></i> Editar Crédito
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}" class="px-3 py-1">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               th:id="'toggleCreditoDescargable-' + ${credito.id}"
                                               th:checked="${credito.descargable}"
                                               th:onchange="'toggleCreditoDescargable(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCreditoDescargable-' + ${credito.id}">
                                            Descargable
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               th:id="'toggleCredito-' + ${credito.id}"
                                               th:checked="${credito.editable}"
                                               th:onchange="'toggleCredito(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCredito-' + ${credito.id}">
                                            Editable
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>

                <!-- Si no hay créditos, mostrar solo celdas vacías -->
                <th:block th:if="${#lists.isEmpty(creditos)}">
                    <th:block th:with="ROWS_PER_PAGE=10">
                        <tr th:each="i : ${#numbers.sequence(1, ROWS_PER_PAGE)}" style="height:55px;">
                            <td th:if="${usuario?.rol == 'ROLE_ADMIN'}" style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                        </tr>
                    </th:block>
                </th:block>

                <!-- Si hay créditos, relleno automático hasta 10 -->
                <th:block th:if="${!#lists.isEmpty(creditos)}">
                    <th:block th:with="ROWS_PER_PAGE=10,
                                     totalSize=${creditos.size()},
                                     remainder=${totalSize % ROWS_PER_PAGE},
                                     fillerRowsNeeded=${(remainder == 0 and totalSize > 0) ? 0 : ROWS_PER_PAGE - remainder}">
                        <tr th:if="${fillerRowsNeeded < ROWS_PER_PAGE}"
                            th:each="i : ${#numbers.sequence(1, fillerRowsNeeded)}"
                            style="height:55px;">
                            <td th:if="${usuario?.rol == 'ROLE_ADMIN'}" style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                            <td style="border-top: none;">&nbsp;</td>
                        </tr>
                    </th:block>
                </th:block>

                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>
</div>





<!-- Creditos rechazados Table -->
<div th:fragment="rechazados-table-content(creditos)">
    <div class="table-wrapper">
        <div id="rechazadosTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th th:if="${usuario?.rol == 'ROLE_ADMIN'}">Usuario</th>
                    <th>Monto</th>
                    <th>Motivo</th>
                    <th>Fecha Solicitud</th>
                    <th>Acción</th>
                </tr>
                </thead>
                <tbody th:if="${not #lists.isEmpty(creditos)}" th:each="credito : ${creditos}">
                <tr>
                    <td style="max-width: 475px;"th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                        <img th:if="${credito.usuario?.foto != null}" th:src="${credito.usuario?.foto}" class="table-user-avatar" alt="User Image"/>
                        <span th:text="${credito.usuario?.nombre + ' ' + credito.usuario?.apellido}"></span>
                    </td>
                    <td style="max-width: 100px;" th:text="${credito.monto}"></td>
                    <td style="flex: 1;" th:text="${credito.nota}"></td>
                    <td style="max-width: 100px;" th:text="${credito.usuarioSolicitud != null ? #temporals.format(credito.usuarioSolicitud.fechaSolicitud, 'dd/MM/yyyy') : 'N/A'}"></td>
                    <td style="max-width: 115px;">
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                Acciones
                            </button>
                            <ul class="dropdown-menu p-2">
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or ((usuario?.rol == 'ROLE_USER' or usuario?.rol == 'ROLE_SECRETARIA') and credito.descargable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'mostrarPDFModal(' + ${credito.id} + ')'">
                                        <i class="fas fa-file-pdf"></i> Generar Documentos
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or (usuario?.rol == 'ROLE_SECRETARIA' and credito.editable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/credito/edit/' + ${credito.id} + '\';'">
                                        <i class="fas fa-edit"></i> Editar Crédito
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}" class="px-3 py-1">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               th:id="'toggleCreditoDescargable-' + ${credito.id}"
                                               th:checked="${credito.descargable}"
                                               th:onchange="'toggleCreditoDescargable(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCreditoDescargable-' + ${credito.id}">
                                            Descargable
                                        </label>
                                    </div>
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               th:id="'toggleCredito-' + ${credito.id}"
                                               th:checked="${credito.editable}"
                                               th:onchange="'toggleCredito(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCredito-' + ${credito.id}">
                                            Editable
                                        </label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                </tbody>
                <tbody th:if="${#lists.isEmpty(creditos)}">
                <tr>
                    <td th:colspan="${usuario?.rol == 'ROLE_ADMIN' ? 6 : 5}" class="text-center text-muted">No tienes créditos registrados</td>
                </tr>
                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>
</div>

<!-- Creditos finalizados Table -->
<div th:fragment="finalizados-table-content(creditos)">
    <div class="table-wrapper">
        <div id="finalizadosTable" class="table-switchable-table">
            <table class="table">
                <thead>
                <tr>
                    <th th:if="${usuario?.rol == 'ROLE_ADMIN'}">Usuario</th>
                    <th>Monto</th>
                    <th>Frecuencia de pago</th>
                    <th>Fecha de Solicitud</th>
                    <th>Fecha de Refinanciamiento</th>
                    <th>Acción</th>
                </tr>
                </thead>
                <tbody th:if="${not #lists.isEmpty(creditos)}" th:each="credito : ${creditos}">
                <tr>
                    <td th:if="${usuario?.rol == 'ROLE_ADMIN'}">
                        <img th:if="${credito.usuario?.foto != null}" th:src="${credito.usuario?.foto}" class="table-user-avatar" alt="User Image"/>
                        <span th:text="${credito.usuario?.nombre + ' ' + credito.usuario?.apellido}"></span>
                    </td>
                    <td th:text="${credito.monto}"></td>
                    <td th:text="${credito.plazoFrecuencia}"></td>
                    <td th:text="${credito.usuarioSolicitud != null ? #temporals.format(credito.usuarioSolicitud.fechaSolicitud, 'dd/MM/yyyy') : 'N/A'}"></td>
                    <td th:text="${#temporals.format(credito.fechaRefinanciado, 'dd/MM/yyyy')}"></td>
                    <td>
                        <div class="btn-group">
                            <button type="button" class="btn btn-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                Acciones
                            </button>
                            <ul class="dropdown-menu p-2">
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN' or ((usuario?.rol == 'ROLE_USER' or usuario?.rol == 'ROLE_SECRETARIA' or usuario?.rol == 'ROLE_GERENTE') and credito.descargable)}">
                                    <a class="dropdown-item" href="#" th:onclick="'mostrarPDFModal(' + ${credito.id} + ')'">
                                        <i class="fas fa-file-pdf"></i> Generar Documentos
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol != 'ROLE_USER'}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/admin/usuarios/' + ${credito.usuario?.id} + '/creditos/' + ${credito.id} + '/cuotas\''">
                                        <i class="fas fa-calendar-alt"></i> Ver cuotas
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_USER'}">
                                    <a class="dropdown-item" href="#" th:onclick="'window.location.href=\'/usuario/credito/cuotas/' + ${credito.id} + '\''">
                                        <i class="fas fa-calendar-alt"></i> Ver cuotas
                                    </a>
                                </li>
                                <li th:if="${usuario?.rol == 'ROLE_ADMIN'}" class="px-3 py-1">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" th:id="'toggleCreditoDescargable-' + ${credito.id}" th:checked="${credito.descargable}" th:onchange="'toggleCreditoDescargable(' + ${credito.id} + ', this.checked)'">
                                        <label class="form-check-label" th:for="'toggleCreditoDescargable-' + ${credito.id}">Descargable</label>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                </tbody>
                <tbody th:if="${#lists.isEmpty(creditos)}">
                <tr>
                    <td th:colspan="${usuario?.rol == 'ROLE_ADMIN' ? 7 : 6}" class="text-center text-muted">No tienes créditos registrados</td>
                </tr>
                </tbody>
            </table>
            <div class="pagination-container"></div>
        </div>
    </div>

</div>
</html>