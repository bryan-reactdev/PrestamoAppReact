<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{appDashboard/user/layout :: layout(
          pageTitle='Simulación de Prestamo',
          pageSubtitle='Simula un prestamo',
          activePage='simular',
          content=~{::content},
          pageCss=~{::css},
          pageScripts=~{::scripts}
      )}">

<head>
    <th:block th:fragment="css">
        <link href="/appDashboard/user/css/solicitar.css" rel="stylesheet" type="text/css" />
        <style>
            /* Ensure results are hidden initially */
            body .solicitar-credito-form #resultadosSimulacion {
                display: none !important;
            }
            
            /* Show results when active class is added */
            body .solicitar-credito-form #resultadosSimulacion.show-results {
                display: grid !important;
            }
        </style>
    </th:block>
</head>

<body>

<div th:fragment="content" class="solicitar-credito-form">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/usuario/panel"><i class="fas fa-tachometer-alt"></i> Home</a></li>
            <li class="breadcrumb-item active" aria-current="page" th:text="${pageTitle}"></li>
        </ol>
    </nav>

    <!-- Simulación de Crédito -->
    <div class="form-grid full-width">
        <div class="section-card full-width">
            <div class="section-header">
                <div class="section-header-left">
                    <i class="fas fa-calculator"></i>
                    Simulación de Crédito
                </div>
            </div>
            <div class="section-content">
                <div class="summary-grid">
                    <div class="summary-item financial-field monto-highlight">
                        <div class="summary-label">Monto a Simular</div>
                        <input type="number" step="0.01" id="montoSimulacion" name="montoSimulacion" required class="summary-value" placeholder="$0.00">
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Plazo (meses)</div>
                        <select id="plazoSimulacion" name="plazoSimulacion" required class="summary-value">
                            <option value="">Seleccionar plazo</option>
                            <option value="3">3 meses</option>
                            <option value="6">6 meses</option>
                            <option value="12">12 meses</option>
                            <option value="18">18 meses</option>
                            <option value="24">24 meses</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 32px;">
                    <button type="button" class="btn-primary" onclick="calcularSimulacion()">
                        <i class="fas fa-calculator" style="margin-right: 8px;"></i>
                        Realizar Simulación
                    </button>
                </div>

                <!-- Resultados de la Simulación -->
                <div id="resultadosSimulacion" class="summary-grid" style="margin-top: 32px;">
                    <div class="summary-item financial-field">
                        <div class="summary-label">Monto Original</div>
                        <div class="summary-value" id="montoOriginal" style="background: #f8f9fa; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; font-weight: 600; color: #2c3e50;"></div>
                    </div>
                    <div class="summary-item financial-field">
                        <div class="summary-label">Interés Base</div>
                        <div class="summary-value" id="interesCalculado" style="background: #f8f9fa; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; font-weight: 600; color: #e74c3c;"></div>
                    </div>
                    <div class="summary-item financial-field">
                        <div class="summary-label">Comisión Base</div>
                        <div class="summary-value" id="comisionCalculada" style="background: #f8f9fa; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; font-weight: 600; color: #e74c3c;"></div>
                    </div>
                    <div class="summary-item financial-field monto-highlight">
                        <div class="summary-label">Total a Pagar</div>
                        <div class="summary-value" id="totalPagar" style="background: #f8f9fa; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; font-weight: 700; color: #3b82f6; font-size: 18px;"></div>
                    </div>
                    <div class="summary-item financial-field monto-highlight" style="grid-column: 1 / -1;">
                        <div class="summary-label">Cuota Mensual</div>
                        <div class="summary-value" id="cuotaMensual" style="background: #f8f9fa; border: 1px solid #ddd; padding: 8px 12px; border-radius: 4px; font-weight: 700; color: #27ae60; font-size: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block th:fragment="scripts">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.3.1/decimal.min.js"></script>

    <script>
        function calcularSimulacion() {
            const montoInput = document.getElementById('montoSimulacion').value;
            const plazoInput = document.getElementById('plazoSimulacion').value;

            if (!montoInput || !plazoInput) {
                Swal.fire({ icon: 'warning', title: 'Campos Requeridos', text: 'Complete monto y plazo.', confirmButtonText: 'Entendido' });
                return;
            }

            // Use Decimal.js for high-precision arithmetic
            const monto = new Decimal(montoInput);
            const porcentajeInteres = new Decimal('10');      // 10% interest
            const comision = new Decimal('100');              // Fixed $100 commission
            const plazo = new Decimal(plazoInput);
            const cien = new Decimal('100');

            // Match Java calculation exactly: interés = monto * (porcentajeInteres / 100)
            // Round to 2 decimal places with HALF_UP rounding
            const interes = monto.times(porcentajeInteres)
                                .dividedBy(cien)
                                .toDecimalPlaces(2, Decimal.ROUND_HALF_UP);
            
            // totalPagar = monto + interes + comision
            const totalPagar = monto.plus(interes).plus(comision);

            // cuotaMensual = totalPagar / plazo
            // Round to 2 decimal places with HALF_UP rounding (matches Java)
            const cuotaMensual = totalPagar.dividedBy(plazo)
                                        .toDecimalPlaces(2, Decimal.ROUND_HALF_UP);

            const formatearMoneda = (valor) =>
                new Intl.NumberFormat('es-SV', {
                    style: 'currency', currency: 'USD', minimumFractionDigits: 2
                }).format(valor.toNumber());

            document.getElementById('montoOriginal').textContent = formatearMoneda(monto);
            document.getElementById('interesCalculado').textContent = formatearMoneda(interes);
            document.getElementById('comisionCalculada').textContent = formatearMoneda(comision);
            document.getElementById('totalPagar').textContent = formatearMoneda(totalPagar);
            document.getElementById('cuotaMensual').textContent = formatearMoneda(cuotaMensual);

            const resultados = document.getElementById('resultadosSimulacion');
            resultados.classList.add('show-results');
            resultados.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Función para ocultar resultados cuando se enfoca en los inputs
        function ocultarResultados() {
            document.getElementById('resultadosSimulacion').classList.remove('show-results');
        }

        // Agregar event listeners cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            const montoInput = document.getElementById('montoSimulacion');
            const plazoInput = document.getElementById('plazoSimulacion');
            
            // Ocultar resultados cuando se enfoca en cualquiera de los inputs
            montoInput.addEventListener('focus', ocultarResultados);
            plazoInput.addEventListener('focus', ocultarResultados);
        });
    </script>
</th:block>

</body>
</html>