<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{appDashboard/admin/layout :: layout(
          pageTitle='Cuotas de Créditos del usuario ' + ${creditoUsuario.nombre},
          pageSubtitle='Gestión de cuotas de créditos del usuario',
          activePage='usuarios',
          content=~{::content},
          pageCss=~{::css},
          pageScripts=~{::scripts}
      )}">

<head>
    <th:block th:fragment="css">
    </th:block>
</head>

<body>

<div th:fragment="content">
    
    <!-- Table Tab Switcher -->
    <div class="table-tab-switcher">
        <div>
            <button th:if="${cuotas != null and #lists.size(cuotas) > 0}"
                    class="btn btn-sm btn-danger"
                    th:onclick="'descargarPDF(' + ${cuotas[0].credito.id} + ')'">
                Descargar PDF
            </button>
            <button type="button" class="table-switcher active" data-table-target="#todosCuotasTable">
                Todas
            </button>
            <button type="button" class="table-switcher" data-table-target="#vencidasCuotasTable">
                Vencidas
            </button>
            <button type="button" class="table-switcher" data-table-target="#pendientesCuotasTable">
                Pendientes
            </button>
            <button type="button" class="table-switcher" data-table-target="#enrevisionCuotasTable">
                En Revisión
            </button>
            <button type="button" class="table-switcher" data-table-target="#pagadasCuotasTable">
                Pagadas
            </button>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar créditos..." />
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Table Containers - All cuota tables -->
    <div th:replace="~{fragments/cuotaTables :: todos-cuotas-table-content(cuotas=${cuotas})}"></div>
    <div th:replace="~{fragments/cuotaTables :: vencidas-cuotas-table-content(cuotas=${cuotasVencidas})}"></div>
    <div th:replace="~{fragments/cuotaTables :: pendientes-cuotas-table-content(cuotas=${cuotasPendientes})}"></div>
    <div th:replace="~{fragments/cuotaTables :: enrevision-cuotas-table-content(cuotas=${cuotasEnRevision})}"></div>
    <div th:replace="~{fragments/cuotaTables :: pagadas-cuotas-table-content(cuotas=${cuotasPagadas})}"></div>

    <!-- Table switcher scripts (include only once per page, at the end) -->
    <div th:replace="~{fragments/tableScripts :: table-switcher-scripts}"></div>
    
    <!-- Modal content for cuota details -->
    <div th:replace="~{fragments/cuotaModals :: cuota-modal-content(cuotas=${cuotas})}"></div>
    <div th:replace="~{fragments/cuotaModals :: cuota-pagar-modal-content(cuotas=${cuotas})}"></div>
</div>

<th:block th:fragment="scripts">
    <script>
        function descargarPDF(creditoId) {
            Swal.fire({
                title: 'Opciones del PDF',
                html: `
                    <div class="swal2-options-container">
                        <label class="swal2-checkbox-label">
                            <input type="checkbox" id="mostrarEstado" class="swal2-checkbox">
                            <span class="swal2-label-text">Mostrar Estado</span>
                        </label>
                        <label class="swal2-checkbox-label">
                            <input type="checkbox" id="mostrarObservaciones" class="swal2-checkbox">
                            <span class="swal2-label-text">Mostrar Observaciones</span>
                        </label>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Generar PDF',
                cancelButtonText: 'Cancelar',
                customClass: {
                    popup: 'swal2-pdf-options'
                },
                didOpen: () => {
                    // Add some custom styling if needed
                    const container = document.querySelector('.swal2-options-container');
                    if (container) {
                        container.style.display = 'flex';
                        container.style.flexDirection = 'column';
                        container.style.gap = '15px';
                        container.style.margin = '20px 0';
                    }
                    
                    const labels = document.querySelectorAll('.swal2-checkbox-label');
                    labels.forEach(label => {
                        label.style.display = 'flex';
                        label.style.alignItems = 'center';
                        label.style.gap = '10px';
                        label.style.cursor = 'pointer';
                    });
                    
                    const checkboxes = document.querySelectorAll('.swal2-checkbox');
                    checkboxes.forEach(checkbox => {
                        checkbox.style.width = '18px';
                        checkbox.style.height = '18px';
                    });
                    
                    const labelTexts = document.querySelectorAll('.swal2-label-text');
                    labelTexts.forEach(text => {
                        text.style.fontSize = '16px';
                        text.style.userSelect = 'none';
                    });
                },
                preConfirm: () => {
                    const mostrarEstado = document.getElementById('mostrarEstado').checked;
                    const mostrarObservaciones = document.getElementById('mostrarObservaciones').checked;
                    
                    return {
                        mostrarEstado: mostrarEstado,
                        mostrarObservaciones: mostrarObservaciones
                    };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const options = result.value;
                    
                    // Prepare the request with options
                    const formData = new FormData();
                    formData.append('mostrarEstado', options.mostrarEstado);
                    formData.append('mostrarObservaciones', options.mostrarObservaciones);
                    
                    fetch(`/admin/pdf/cuotas/${creditoId}`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(res => {
                        if (!res.ok) throw new Error('Error al generar PDF');
                        return res.blob();
                    })
                    .then(blob => {
                        const url = window.URL.createObjectURL(blob);

                        // Detectar móvil
                        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                        if (isMobile) {
                            window.open(url, '_blank'); // abre PDF en nueva pestaña
                        } else {
                            // PC: iframe oculto y print
                            const iframe = document.createElement('iframe');
                            iframe.style.display = 'none';
                            iframe.src = url;
                            iframe.onload = function () {
                                iframe.contentWindow.print();
                                setTimeout(() => window.URL.revokeObjectURL(url), 1000);
                            };

                            document.body.appendChild(iframe);
                        }
                        
                        // Show success message
                        Swal.fire({
                            icon: 'success',
                            title: 'PDF generado',
                            text: 'El PDF se ha generado correctamente',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    })
                    .catch(error => {
                        console.error(error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al generar el PDF'
                        });
                    });
                }
            });
        }
    </script>
</th:block>

</body>
</html>