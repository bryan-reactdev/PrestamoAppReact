<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{appDashboard/admin/layout :: layout(
          pageTitle='Historial',
          pageSubtitle='GestiÃ³n de historial',
          activePage='historial',
          content=~{::content},
          pageCss=~{::css},
          pageScripts=~{::scripts}
      )}">

<head>
    <th:block th:fragment="css">
        <!-- Your CSS here -->
    </th:block>
</head>

<body>

<div th:fragment="content">
    <!-- Table Tab Switcher -->
    <div class="table-tab-switcher">
        <div>
            <button type="button" class="table-switcher active" data-table-target="#todosTable">
                Todos
            </button>
            <button type="button" class="table-switcher" data-table-target="#hoyTable">
                Hoy
            </button>
            <button type="button" class="table-switcher" data-table-target="#semanaTable">
                Semana
            </button>
            <button type="button" class="table-switcher" data-table-target="#mesTable">
                Mes
            </button>
        </div>
        
        <!-- Month Navigation (initially hidden) -->
        <div id="monthNavigation" class="month-navigation" style="display: none;">
            <button id="prevMonthBtn" class="btn btn-sm btn-outline-secondary mr-2">
                &laquo; Mes Anterior
            </button>
            <span id="currentMonthDisplay" class="mx-2"></span>
            <button id="nextMonthBtn" class="btn btn-sm btn-outline-secondary ml-2">
                Mes Siguiente &raquo;
            </button>
        </div>

        <!-- Week Navigation (initially hidden) -->
        <div id="weekNavigation" class="week-navigation" style="display: none;">
            <button id="prevWeekBtn" class="btn btn-sm btn-outline-secondary mr-2">
                &laquo; Semana Anterior
            </button>
            <span id="currentWeekDisplay" class="mx-2"></span>
            <button id="nextWeekBtn" class="btn btn-sm btn-outline-secondary ml-2">
                Semana Siguiente &raquo;
            </button>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar historial..." />
                <div class="input-group-append">
                    <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="~{fragments/historialTables :: todos-table-content(usuarioAcciones=${usuarioAcciones})}"></div>
    <div th:replace="~{fragments/historialTables :: hoy-table-content(usuarioAcciones=${usuarioAcciones})}"></div>
    <div th:replace="~{fragments/historialTables :: semana-table-content(usuarioAcciones=${usuarioAcciones})}"></div>
    <div th:replace="~{fragments/historialTables :: mes-table-content(usuarioAcciones=${usuarioAcciones})}"></div>

    <div th:replace="~{fragments/tableScripts :: table-switcher-scripts}"></div>
</div>
    
<th:block th:fragment="scripts">
    <script> 
        // --- Navegacion ---

        // -- Mes --
        let currentViewMonth = new Date(); // Track which month we're viewing
        
        // Update month display
        function updateMonthDisplay() {
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
            "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const displayElement = document.getElementById('currentMonthDisplay');
            displayElement.textContent = `${monthNames[currentViewMonth.getMonth()]} ${currentViewMonth.getFullYear()}`;
        }

        // Navigate to previous month
        function goToPreviousMonth() {
            currentViewMonth.setMonth(currentViewMonth.getMonth() - 1);
            updateMonthDisplay();
            filterTableByDate('mesTable', dateFilters.mes, currentViewMonth);
        }
        
        // Navigate to next month
        function goToNextMonth() {
            currentViewMonth.setMonth(currentViewMonth.getMonth() + 1);
            updateMonthDisplay();
            filterTableByDate('mesTable', dateFilters.mes, currentViewMonth);
        }
        
        // -- Semana
        let currentViewWeek = new Date(); // Track which week we're viewing

        // Update week display
        function updateWeekDisplay() {
            const startOfWeek = new Date(currentViewWeek);
            startOfWeek.setDate(currentViewWeek.getDate() - currentViewWeek.getDay());
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            const displayElement = document.getElementById('currentWeekDisplay');
            const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
            
            displayElement.textContent = `${startOfWeek.getDate()} ${monthNames[startOfWeek.getMonth()]} - ${endOfWeek.getDate()} ${monthNames[endOfWeek.getMonth()]} ${endOfWeek.getFullYear()}`;
        }

        // Navigate to previous week
        function goToPreviousWeek() {
            currentViewWeek.setDate(currentViewWeek.getDate() - 7);
            updateWeekDisplay();
            filterTableByDate('semanaTable', dateFilters.semana, currentViewWeek);
        }

        // Navigate to next week
        function goToNextWeek() {
            currentViewWeek.setDate(currentViewWeek.getDate() + 7);
            updateWeekDisplay();
            filterTableByDate('semanaTable', dateFilters.semana, currentViewWeek);
}

        // Helper function to parse date from table cell
        function parseDateFromCell(cell) {
            if (!cell) return null;
            
            const dateParts = cell.textContent.split(' ');
            const dateOnly = dateParts[0]; // "dd/MM/yyyy"
            const [day, month, year] = dateOnly.split('/');
            
            // Create a Date object (month is 0-indexed in JavaScript)
            return new Date(year, month - 1, day);
        }
        
        // Helper function to filter and update table
        function filterTableByDate(tableId, dateFilter, referenceDate = new Date()) {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const dateCell = row.querySelector('td:nth-child(3)');
                const rowDate = parseDateFromCell(dateCell);
                
                if (rowDate) {
                    const shouldShow = dateFilter(rowDate, referenceDate);
                    row.style.display = shouldShow ? '' : 'none';
                    row.dataset.visible = shouldShow ? 'true' : 'false';
                }
            });
            
            // Update pagination
            if (window.setupPagination) {
                window.setupPagination(table, tableId);
                window.changePage(tableId, 1);
            }
        }
        
        // Date filter functions
        const dateFilters = {
            hoy: (rowDate, today) => rowDate.toDateString() === today.toDateString(),
            
            semana: (rowDate, today) => {
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay());
                startOfWeek.setHours(0, 0, 0, 0);
                
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);
                endOfWeek.setHours(23, 59, 59, 999);
                
                return rowDate >= startOfWeek && rowDate <= endOfWeek;
            },
            
            mes: (rowDate, today) => {
                const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                endOfMonth.setHours(23, 59, 59, 999);
                
                return rowDate >= startOfMonth && rowDate <= endOfMonth;
            }
        };

        document.addEventListener('DOMContentLoaded', function() {            
            // --- Navegacion ---

            // -- Mes --
            const monthNav = document.getElementById('monthNavigation');
            updateMonthDisplay();
            
            document.getElementById('prevMonthBtn').addEventListener('click', goToPreviousMonth);
            document.getElementById('nextMonthBtn').addEventListener('click', goToNextMonth);            

            // Semana
            const weekNav = document.getElementById('weekNavigation');
            updateWeekDisplay();

            document.getElementById('prevWeekBtn').addEventListener('click', goToPreviousWeek);
            document.getElementById('nextWeekBtn').addEventListener('click', goToNextWeek);
            
            // Listen for tab changes
            document.addEventListener('tableTabChanged', function(e) {
                monthNav.style.display = e.detail.targetId === 'mesTable' ? 'block' : 'none';
                weekNav.style.display = e.detail.targetId === 'semanaTable' ? 'block' : 'none';

                switch(e.detail.targetId) {
                    case 'todosTable':
                        break;
                        
                    case 'hoyTable':
                        filterTableByDate('hoyTable', dateFilters.hoy);
                        break;
                        
                    case 'semanaTable':
                        currentViewWeek = new Date();
                        updateWeekDisplay();
                        filterTableByDate('semanaTable', dateFilters.semana, currentViewWeek);
                    break;
                        
                    case 'mesTable':
                        // Reset to current month when switching to mes tab
                        currentViewMonth = new Date();
                        updateMonthDisplay();
                        filterTableByDate('mesTable', dateFilters.mes, currentViewMonth);
                        break;
                }
            });
        });
    </script>
</th:block>

</body>
</html>